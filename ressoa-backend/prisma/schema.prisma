generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Domínio Organizacional - Auth & Multi-tenancy
// ============================================

enum RoleUsuario {
  PROFESSOR
  COORDENADOR
  DIRETOR
  ADMIN
}

enum Serie {
  SEXTO_ANO
  SETIMO_ANO
  OITAVO_ANO
  NONO_ANO
}

enum TipoEntrada {
  AUDIO
  TRANSCRICAO
  MANUAL
}

enum StatusProcessamento {
  CRIADA
  UPLOAD_PROGRESSO
  AGUARDANDO_TRANSCRICAO
  TRANSCRITA
  ANALISANDO
  ANALISADA
  APROVADA
  REJEITADA
  ERRO
}

enum ProviderSTT {
  WHISPER
  GOOGLE
  AZURE
  MANUAL
}

enum TipoNotificacao {
  TRANSCRICAO_PRONTA
  ANALISE_PRONTA
  ERRO_PROCESSAMENTO
  SISTEMA
}

enum ProviderLLM {
  CLAUDE_SONNET
  CLAUDE_HAIKU
  GPT4_TURBO
  GPT4_MINI
  GEMINI_PRO
  GEMINI_FLASH
}

enum StatusAnalise {
  AGUARDANDO_REVISAO // Freshly generated, awaiting professor review
  APROVADO           // Approved by professor
  REJEITADO          // Rejected by professor
}

model Escola {
  id             String   @id @default(uuid())
  nome           String
  cnpj           String?  @unique
  email_contato  String?
  telefone       String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  usuarios       Usuario[]
  turmas         Turma[]
  planejamentos  Planejamento[]
  aulas          Aula[]

  @@map("escola")
}

model Usuario {
  id          String   @id @default(uuid())
  nome        String
  email       String
  senha_hash  String
  escola_id   String?  // Nullable para ADMIN (não pertence a escola)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  escola          Escola?        @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  perfil_usuario  PerfilUsuario?
  turmas          Turma[]
  planejamentos   Planejamento[]
  aulas           Aula[]
  notificacoes    Notificacao[]

  @@unique([email, escola_id])  // PostgreSQL permite múltiplos NULL sem violar unique
  @@index([escola_id])
  @@index([email])
  @@map("usuario")
}

model PerfilUsuario {
  id                  String       @id @default(uuid())
  usuario_id          String       @unique
  role                RoleUsuario  @default(PROFESSOR)
  notificacoes_email  Boolean      @default(true)
  created_at          DateTime     @default(now())
  updated_at          DateTime     @updatedAt

  // Relations
  usuario             Usuario      @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@map("perfil_usuario")
}

// ============================================
// Domínio Currículo - BNCC
// ============================================

model Disciplina {
  id         String   @id @default(uuid())
  codigo     String   @unique // MATEMATICA, LINGUA_PORTUGUESA, CIENCIAS
  nome       String // Matemática, Língua Portuguesa, Ciências
  area       String // Matemática, Linguagens, Ciências da Natureza
  ordem      Int // 1, 2, 3
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("disciplinas")
}

model Ano {
  id         String   @id @default(uuid())
  codigo     String   @unique // 6_ANO, 7_ANO, 8_ANO, 9_ANO
  nome       String // 6º Ano, 7º Ano, 8º Ano, 9º Ano
  ordem      Int // 6, 7, 8, 9
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  habilidades HabilidadeAno[]

  @@map("anos")
}

model Habilidade {
  id                  String   @id @default(uuid())
  codigo              String   @unique // EF06MA01, EF67LP03, EF69LP10, etc.
  descricao           String   @db.Text
  disciplina          String // MATEMATICA, LINGUA_PORTUGUESA, CIENCIAS
  ano_inicio          Int // 6, 7, 8, 9
  ano_fim             Int? // NULL para habilidades específicas, 7/9 para blocos compartilhados
  unidade_tematica    String? // Números, Álgebra, Práticas de Linguagem, etc.
  objeto_conhecimento String?  @db.Text
  versao_bncc         String   @default("2018") // Versionamento (futuro: 2024?)
  ativa               Boolean  @default(true) // Soft delete
  searchable          Unsupported("tsvector")? @default(dbgenerated("(setweight(to_tsvector('portuguese'::regconfig, COALESCE(codigo, ''::text)), 'A'::\"char\") || setweight(to_tsvector('portuguese'::regconfig, COALESCE(descricao, ''::text)), 'B'::\"char\"))"))
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  anos                        HabilidadeAno[]
  planejamentos_habilidades   PlanejamentoHabilidade[]

  @@index([disciplina, ano_inicio])
  @@index([codigo])
  @@index([ativa])
  @@index([searchable], map: "idx_habilidade_searchable", type: Gin)
  @@map("habilidades")
}

model HabilidadeAno {
  id            String     @id @default(uuid())
  habilidade_id String
  habilidade    Habilidade @relation(fields: [habilidade_id], references: [id], onDelete: Cascade)
  ano_id        String
  ano           Ano        @relation(fields: [ano_id], references: [id], onDelete: Cascade)
  created_at    DateTime   @default(now())

  @@unique([habilidade_id, ano_id])
  @@index([ano_id])
  @@map("habilidades_anos")
}

// ============================================
// Domínio Planejamento - Turmas & Planejamento Bimestral
// ============================================

model Turma {
  id            String      @id @default(uuid())
  nome          String      // ex: "6A", "7B"
  disciplina    String      // Código da disciplina: MATEMATICA, LINGUA_PORTUGUESA, CIENCIAS
  serie         Serie
  ano_letivo    Int
  escola_id     String
  professor_id  String
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt

  // Relations
  escola        Escola      @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  professor     Usuario     @relation(fields: [professor_id], references: [id], onDelete: Cascade)
  planejamentos Planejamento[]
  aulas         Aula[]

  @@index([escola_id])
  @@index([professor_id])
  @@index([ano_letivo, disciplina])
  @@map("turma")
}

model Planejamento {
  id                     String    @id @default(uuid())
  turma_id               String
  bimestre               Int       // 1-4
  ano_letivo             Int
  escola_id              String
  professor_id           String
  validado_coordenacao   Boolean   @default(false)
  deleted_at             DateTime? // Soft delete (LGPD compliance)
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt

  // Relations
  escola                 Escola   @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  professor              Usuario  @relation(fields: [professor_id], references: [id], onDelete: Cascade)
  turma                  Turma    @relation(fields: [turma_id], references: [id], onDelete: Cascade)
  habilidades            PlanejamentoHabilidade[]
  aulas                  Aula[]
  analises               Analise[] // Análises que usaram este planejamento

  @@unique([turma_id, bimestre, ano_letivo]) // RN-PLAN-04: Sem duplicatas
  @@index([escola_id])
  @@index([professor_id])
  @@index([turma_id])
  @@index([ano_letivo, bimestre])
  @@index([deleted_at])
  @@map("planejamento")
}

model PlanejamentoHabilidade {
  id                String        @id @default(uuid())
  planejamento_id   String
  habilidade_id     String
  peso              Float         @default(1.0) // RN-PLAN-02: Peso padrão 1.0
  aulas_previstas   Int?          // RN-PLAN-03: Opcional, estimado se não fornecido
  created_at        DateTime      @default(now())

  // Relations
  planejamento      Planejamento  @relation(fields: [planejamento_id], references: [id], onDelete: Cascade)
  habilidade        Habilidade    @relation(fields: [habilidade_id], references: [id], onDelete: Cascade)

  @@unique([planejamento_id, habilidade_id]) // N:N sem duplicatas
  @@index([planejamento_id])
  @@index([habilidade_id])
  @@map("planejamento_habilidade")
}

// ============================================
// Domínio Execução - Aulas & Processamento
// ============================================

model Transcricao {
  id                       String      @id @default(uuid())
  aula_id                  String      @unique
  texto                    String      @db.Text
  provider                 ProviderSTT
  idioma                   String      @default("pt-BR")
  duracao_segundos         Int?
  confianca                Float?      // 0.0-1.0
  custo_usd                Float?      // Cost tracking
  tempo_processamento_ms   Int?
  metadata_json            Json?       // Provider-specific data
  created_at               DateTime    @default(now())
  updated_at               DateTime    @updatedAt

  aula     Aula      @relation(fields: [aula_id], references: [id], onDelete: Cascade)
  analises Analise[] // A transcricao pode ter múltiplas análises (reprocessamento)

  @@index([aula_id])
  @@index([provider, created_at])
  @@map("transcricao")
}

model Analise {
  id                       String   @id @default(uuid())
  aula_id                  String   @unique // One analysis per aula (current implementation)
  transcricao_id           String
  planejamento_id          String?  // Nullable - aula pode não ter planejamento

  // Outputs dos 5 prompts (pipeline serial)
  cobertura_json           Json     // Prompt 1: { habilidades: [ { codigo, nivel_cobertura, evidencias } ] }
  analise_qualitativa_json Json     // Prompt 2: { bloom_levels, metodologias, adequacao_cognitiva, sinais_engajamento }
  relatorio_texto          String   @db.Text // Prompt 3: Relatório narrativo formatado em markdown (ORIGINAL)
  relatorio_editado        String?  @db.Text // Versão editada pelo professor (Story 6.2)
  exercicios_json          Json     // Prompt 4: [ { enunciado, gabarito, nivel_bloom, ... } ]
  exercicios_editado       Json?    // Versão editada (Story 6.3)
  alertas_json             Json     // Prompt 5: [ { tipo, nivel, mensagem, ... } ]

  // Status tracking (Story 6.2)
  status                   StatusAnalise @default(AGUARDANDO_REVISAO)

  // Approval/Rejection tracking (Story 6.2)
  aprovado_em              DateTime?
  rejeitado_em             DateTime?
  motivo_rejeicao          String?  @db.Text
  tempo_revisao            Int?     // Seconds between created_at and approval

  // Metadata para observability & A/B testing
  prompt_versoes_json      Json     // { cobertura: "v1.0.0", qualitativa: "v1.1.0", ... }
  custo_total_usd          Float    // Sum of 5 prompts
  tempo_processamento_ms   Int      // Total pipeline time

  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  // Relations
  aula         Aula         @relation(fields: [aula_id], references: [id], onDelete: Cascade)
  transcricao  Transcricao  @relation(fields: [transcricao_id], references: [id])
  planejamento Planejamento? @relation(fields: [planejamento_id], references: [id])

  @@index([aula_id])
  @@index([transcricao_id])
  @@index([status])
  @@map("analise")
}

model Aula {
  id                   String               @id @default(uuid())
  escola_id            String
  professor_id         String
  turma_id             String
  planejamento_id      String?
  data                 DateTime
  tipo_entrada         TipoEntrada
  status_processamento StatusProcessamento  @default(CRIADA)
  arquivo_url          String?              // S3/MinIO URL
  arquivo_tamanho      Int?                 // bytes
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt
  deleted_at           DateTime?            // Soft delete (LGPD compliance)

  // Relations
  escola        Escola        @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  professor     Usuario       @relation(fields: [professor_id], references: [id], onDelete: Cascade)
  turma         Turma         @relation(fields: [turma_id], references: [id], onDelete: Cascade)
  planejamento  Planejamento? @relation(fields: [planejamento_id], references: [id], onDelete: SetNull)
  transcricao   Transcricao?
  analise       Analise?      // One-to-one relation (analise links back to aula)

  @@index([escola_id, professor_id, data])
  @@index([status_processamento])
  @@index([turma_id, data])
  @@index([deleted_at])
  @@map("aula")
}

// ============================================
// Domínio AI/LLM - Prompts Versionados
// ============================================

model Prompt {
  id              String       @id @default(uuid())
  nome            String       // "prompt-cobertura", "prompt-qualitativa", etc
  versao          String       // "v1.0.0", "v1.1.0", etc
  conteudo        String       @db.Text
  variaveis       Json?        // { transcricao, planejamento, habilidades, ... }
  modelo_sugerido ProviderLLM? // CLAUDE, GPT, GEMINI
  ativo           Boolean      @default(false)
  ab_testing      Boolean      @default(false) // Se true, usa split 50/50 com versão anterior
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  @@unique([nome, versao])
  @@index([nome, ativo])
  @@map("prompt")
}

// ============================================
// Domínio Notificações
// ============================================

model Notificacao {
  id            String           @id @default(uuid())
  usuario_id    String
  tipo          TipoNotificacao
  titulo        String
  mensagem      String
  lida          Boolean          @default(false)
  link          String?          // Deep link para ação relevante
  metadata_json Json?
  created_at    DateTime         @default(now())

  // Relations
  usuario       Usuario          @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id, lida, created_at])
  @@map("notificacao")
}
