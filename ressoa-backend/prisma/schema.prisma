generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Domínio Organizacional - Auth & Multi-tenancy
// ============================================

enum RoleUsuario {
  PROFESSOR
  COORDENADOR
  DIRETOR
  ADMIN
}

enum Serie {
  SEXTO_ANO
  SETIMO_ANO
  OITAVO_ANO
  NONO_ANO
}

enum TipoEntrada {
  AUDIO
  TRANSCRICAO
  MANUAL
}

enum StatusProcessamento {
  CRIADA
  UPLOAD_PROGRESSO
  AGUARDANDO_TRANSCRICAO
  TRANSCRITA
  ANALISANDO
  ANALISADA
  APROVADA
  REJEITADA
  ERRO
}

model Escola {
  id             String   @id @default(uuid())
  nome           String
  cnpj           String?  @unique
  email_contato  String?
  telefone       String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  usuarios       Usuario[]
  turmas         Turma[]
  planejamentos  Planejamento[]
  aulas          Aula[]
  transcricoes   Transcricao[]

  @@map("escola")
}

model Usuario {
  id          String   @id @default(uuid())
  nome        String
  email       String
  senha_hash  String
  escola_id   String?  // Nullable para ADMIN (não pertence a escola)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  escola          Escola?        @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  perfil_usuario  PerfilUsuario?
  turmas          Turma[]
  planejamentos   Planejamento[]
  aulas           Aula[]

  @@unique([email, escola_id])  // PostgreSQL permite múltiplos NULL sem violar unique
  @@index([escola_id])
  @@index([email])
  @@map("usuario")
}

model PerfilUsuario {
  id         String       @id @default(uuid())
  usuario_id String       @unique
  role       RoleUsuario  @default(PROFESSOR)
  created_at DateTime     @default(now())
  updated_at DateTime     @updatedAt

  // Relations
  usuario    Usuario      @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@map("perfil_usuario")
}

// ============================================
// Domínio Currículo - BNCC
// ============================================

model Disciplina {
  id         String   @id @default(uuid())
  codigo     String   @unique // MATEMATICA, LINGUA_PORTUGUESA, CIENCIAS
  nome       String // Matemática, Língua Portuguesa, Ciências
  area       String // Matemática, Linguagens, Ciências da Natureza
  ordem      Int // 1, 2, 3
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("disciplinas")
}

model Ano {
  id         String   @id @default(uuid())
  codigo     String   @unique // 6_ANO, 7_ANO, 8_ANO, 9_ANO
  nome       String // 6º Ano, 7º Ano, 8º Ano, 9º Ano
  ordem      Int // 6, 7, 8, 9
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  habilidades HabilidadeAno[]

  @@map("anos")
}

model Habilidade {
  id                  String   @id @default(uuid())
  codigo              String   @unique // EF06MA01, EF67LP03, EF69LP10, etc.
  descricao           String   @db.Text
  disciplina          String // MATEMATICA, LINGUA_PORTUGUESA, CIENCIAS
  ano_inicio          Int // 6, 7, 8, 9
  ano_fim             Int? // NULL para habilidades específicas, 7/9 para blocos compartilhados
  unidade_tematica    String? // Números, Álgebra, Práticas de Linguagem, etc.
  objeto_conhecimento String?  @db.Text
  versao_bncc         String   @default("2018") // Versionamento (futuro: 2024?)
  ativa               Boolean  @default(true) // Soft delete
  searchable          String?  @db.Text // tsvector GENERATED ALWAYS (full-text search) - unsupported type in Prisma
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  anos                        HabilidadeAno[]
  planejamentos_habilidades   PlanejamentoHabilidade[]

  @@index([disciplina, ano_inicio])
  @@index([codigo])
  @@index([ativa])
  @@map("habilidades")
}

model HabilidadeAno {
  id            String     @id @default(uuid())
  habilidade_id String
  habilidade    Habilidade @relation(fields: [habilidade_id], references: [id], onDelete: Cascade)
  ano_id        String
  ano           Ano        @relation(fields: [ano_id], references: [id], onDelete: Cascade)
  created_at    DateTime   @default(now())

  @@unique([habilidade_id, ano_id])
  @@index([ano_id])
  @@map("habilidades_anos")
}

// ============================================
// Domínio Planejamento - Turmas & Planejamento Bimestral
// ============================================

model Turma {
  id            String      @id @default(uuid())
  nome          String      // ex: "6A", "7B"
  disciplina    String      // Código da disciplina: MATEMATICA, LINGUA_PORTUGUESA, CIENCIAS
  serie         Serie
  ano_letivo    Int
  escola_id     String
  professor_id  String
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt

  // Relations
  escola        Escola      @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  professor     Usuario     @relation(fields: [professor_id], references: [id], onDelete: Cascade)
  planejamentos Planejamento[]
  aulas         Aula[]

  @@index([escola_id])
  @@index([professor_id])
  @@index([ano_letivo, disciplina])
  @@map("turma")
}

model Planejamento {
  id                     String    @id @default(uuid())
  turma_id               String
  bimestre               Int       // 1-4
  ano_letivo             Int
  escola_id              String
  professor_id           String
  validado_coordenacao   Boolean   @default(false)
  deleted_at             DateTime? // Soft delete (LGPD compliance)
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt

  // Relations
  escola                 Escola   @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  professor              Usuario  @relation(fields: [professor_id], references: [id], onDelete: Cascade)
  turma                  Turma    @relation(fields: [turma_id], references: [id], onDelete: Cascade)
  habilidades            PlanejamentoHabilidade[]
  aulas                  Aula[]

  @@unique([turma_id, bimestre, ano_letivo]) // RN-PLAN-04: Sem duplicatas
  @@index([escola_id])
  @@index([professor_id])
  @@index([turma_id])
  @@index([ano_letivo, bimestre])
  @@index([deleted_at])
  @@map("planejamento")
}

model PlanejamentoHabilidade {
  id                String        @id @default(uuid())
  planejamento_id   String
  habilidade_id     String
  peso              Float         @default(1.0) // RN-PLAN-02: Peso padrão 1.0
  aulas_previstas   Int?          // RN-PLAN-03: Opcional, estimado se não fornecido
  created_at        DateTime      @default(now())

  // Relations
  planejamento      Planejamento  @relation(fields: [planejamento_id], references: [id], onDelete: Cascade)
  habilidade        Habilidade    @relation(fields: [habilidade_id], references: [id], onDelete: Cascade)

  @@unique([planejamento_id, habilidade_id]) // N:N sem duplicatas
  @@index([planejamento_id])
  @@index([habilidade_id])
  @@map("planejamento_habilidade")
}

// ============================================
// Domínio Execução - Aulas & Processamento
// ============================================

model Transcricao {
  id                String   @id @default(uuid())
  escola_id         String   // Multi-tenancy
  aula_id           String?  @unique // FK para Aula (one-to-one bidirectional)
  texto             String   @db.Text // Transcrição completa
  provider          String   // 'MANUAL', 'WHISPER', 'GOOGLE_SPEECH'
  confianca         Float?   // 0.0-1.0 (null para manual completa, 0.5 para resumo manual)
  duracao_segundos  Int?     // Null para entrada manual
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  escola Escola @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  aula   Aula?  @relation(fields: [aula_id], references: [id], onDelete: SetNull, "AulaTranscricao")

  @@index([escola_id, aula_id])
  @@index([provider])
  @@map("transcricao")
}

model Aula {
  id                   String               @id @default(uuid())
  escola_id            String
  professor_id         String
  turma_id             String
  planejamento_id      String?
  data                 DateTime
  tipo_entrada         TipoEntrada
  status_processamento StatusProcessamento  @default(CRIADA)
  arquivo_url          String?              // S3/MinIO URL
  arquivo_tamanho      Int?                 // bytes
  transcricao_id       String?   @unique    // FK para Transcricao (one-to-one)
  analise_id           String?              // FK para Analise (future)
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt
  deleted_at           DateTime?            // Soft delete (LGPD compliance)

  // Relations
  escola        Escola        @relation(fields: [escola_id], references: [id], onDelete: Cascade)
  professor     Usuario       @relation(fields: [professor_id], references: [id], onDelete: Cascade)
  turma         Turma         @relation(fields: [turma_id], references: [id], onDelete: Cascade)
  planejamento  Planejamento? @relation(fields: [planejamento_id], references: [id], onDelete: SetNull)
  transcricao   Transcricao?  @relation("AulaTranscricao")
  // analise       Analise?      @relation(fields: [analise_id], references: [id])      // Future: Epic 5

  @@index([escola_id, professor_id, data])
  @@index([status_processamento])
  @@index([turma_id, data])
  @@index([deleted_at])
  @@map("aula")
}
